name: Deploy to Local VM

on:
  push:
    branches: [ "main" ]  # Run this whenever code is pushed to 'main'

jobs:
  deploy:
    runs-on: self-hosted  # This tells GitHub to use YOUR VM, not theirs!

    steps:
      - uses: actions/checkout@v3

      - name: Fix Volume Permissions
        run: |
          sudo rm -rf monitoring-data
          mkdir monitoring-data
      # ----------------------------------------------------

      - name: Rebuild and Restart Website
        env:
          DB_USER: ${{ secrets.DB_USER }}
      # ... (rest of the file remains the same)
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
      run: |
        # 1. Pull the latest images
        docker-compose pull

        # 2. TEAR DOWN: Stop and remove the old running container/network.
        docker-compose down --remove-orphans

          # 3. BUILD & START: Create and start the new container stack.
          # Docker Compose will automatically read the variables we defined in 'env:' above
        docker-compose up -d --build
