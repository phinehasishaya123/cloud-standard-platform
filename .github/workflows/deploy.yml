name: Continuous Deployment



on:

  push:

    branches:

      - main

  workflow_dispatch:



jobs:

  deploy:

    runs-on: self-hosted



    steps:

      - uses: actions/checkout@v3



      # ----------------------------------------------------

      # FIX: Forcefully remove and recreate the monitoring volume folder 

      # to bypass the root permission lock (EACCES error).

      - name: Fix Volume Permissions

        run: |

          sudo rm -rf monitoring-data

          mkdir monitoring-data

      # ----------------------------------------------------

          

      - name: Rebuild and Restart Website

        env:

          # Inject secrets as environment variables for Docker Compose to read

          DB_USER: ${{ secrets.DB_USER }}

          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

          DB_NAME: ${{ secrets.DB_NAME }}

        

        run: |

          # 1. Pull the latest images

          docker-compose pull



          # 2. TEAR DOWN: Stop and remove the old running container/network.

          docker-compose down --remove-orphans



          # 3. BUILD & START: Create and start the new container stack.

          # The database credentials are read from the 'env:' block above.

          docker-compose up -d --build
